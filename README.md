# Auction System


## Возможности

- **Аутентификация**: Регистрация и вход с логином/паролем
- **Создание аукционов**: Настройка раундов, времени, победителей, призов
- **Система ставок**: Real-time обновления через WebSocket
- **Антиснайпинг**: Увеличение минимального шага ставки в конце раунда
- **Боты**: Автоматические ставки для создания активности
- **Message Queue**: Обработка ставок через Redis для конкурентности
- **Таблица лидеров**: Топ-10 ставок в реальном времени

## Демо


https://github.com/user-attachments/assets/c3c6db04-153b-4d4c-8981-489755541ad3


## Live сайт
**https://demoauck1.onrender.com/**

## Технологический стек

- **Backend**: Node.js, TypeScript, Fastify
- **Database**: MongoDB
- **Cache/Queue**: Redis
- **Real-time**: WebSocket
- **Frontend**: Vanilla JS, HTML, CSS

## Архитектура

### Общее устройство

- **Fastify API** принимает HTTP-запросы, авторизует пользователей и выдает данные аукционов.
- **MongoDB** хранит сущности аукциона, ставок, пользователей, победителей и транзакций.
- **Redis** используется как очередь ставок и как pub/sub канал для real-time событий.
- **WebSocket** транслирует обновления ставок, таймеров и результатов участникам в реальном времени.

### Подход к обработке ставок

- Ставки складываются в Redis-очередь, чтобы сохранить порядок и избежать гонок.
- Обработчик последовательно применяет ставку, корректируя баланс пользователя и создавая транзакцию.
- В конце раунда сервис подводит итоги, распределяет призы и возвращает средства проигравшим.

### Антиснайпинг (Способ 2)

Система использует поэтапное повышение минимального шага ставки:
- В последние N минут раунда минимальная ставка увеличивается в X раз
- Настраивается при создании аукциона
- По умолчанию: в последние 10 минут шаг увеличивается в 2 раза

### Message Queue

Все ставки обрабатываются через Redis очередь:
- Гарантирует строгий порядок обработки
- Предотвращает race conditions
- Обеспечивает финансовую корректность

### Боты

Автоматические боты создают активность в аукционах:
- 5 ботов с большим балансом
- Делают случайные ставки каждые 8-15 секунд
- Помогают увидеть, что аукцион "живой"


## Установка и запуск

### Вариант 1: Docker Compose с локальными базами (Для локальной разработки)

1. Убедитесь, что установлены Docker и Docker Compose

2. Клонируйте репозиторий:
```bash
git clone https://github.com/xonyae/xauk
cd auction-system
```

3. Запустите все сервисы (MongoDB и Redis будут запущены локально):
```bash
docker-compose up -d
```

4. Приложение будет доступно по адресу: http://localhost:3000

5. Для остановки:
```bash
docker-compose down
```
Либо

1. Установите MongoDB и Redis локально или через Docker:

```bash
# MongoDB
docker run -d -p 27017:27017 --name mongodb mongo:7

# Redis
docker run -d -p 6379:6379 --name redis redis:7-alpine
```

2. Установите зависимости:
```bash
npm install
```

3. Настройте переменные окружения в `.env`:
```env
PORT=3000
NODE_ENV=development
MONGODB_URI=mongodb://localhost:27017/auction-system
REDIS_URL=redis://localhost:6379
JWT_SECRET=test
JWT_EXPIRES_IN=7d
```

**Для облачного Redis (Upstash, Redis Cloud):**
```env
REDIS_URL=rediss://user:password@host:port
```

4. Запустите в режиме разработки:
```bash
npm run dev
```

5. Или соберите и запустите продакшн версию:
```bash
npm run build
npm start
```

6. Откройте браузер: http://localhost:3000


## Использование

### 1. Регистрация

- Откройте http://localhost:3000 либо https://demoauck1.onrender.com/
- Перейдите на вкладку "Register"
- Введите username, password
- Выберите роль (user или judge)
- Нажмите "Register"

### 2. Создание аукциона

- После входа нажмите "Create Auction"
- Заполните форму:
  - **Title**: Название аукциона
  - **Description**: Описание
  - **Rounds**: Количество раундов
  - **Duration**: Длительность раунда в секундах
  - **Winners per Round**: Количество победителей в раунде
  - **Prizes**: Призы через запятую
  - **Min Bid**: Минимальная ставка
- Настройте антиснайпинг (опционально)
- Нажмите "Create Auction"

### 3. Запуск аукциона

- Откройте созданный аукцион
- Нажмите "Start Auction"
- Боты автоматически начнут делать ставки

### 4. Участие в аукционе

- Откройте активный аукцион
- Введите сумму ставки (должна быть больше текущей минимальной)
- Нажмите "Place Bid"
- Ваша ставка появится в таблице лидеров
- Средства будут заморожены до конца раунда

### 5. Пополнение баланса

- Нажмите "Add Balance" в верхнем меню
- Введите сумму
- Баланс будет обновлен

## API Endpoints

### Authentication
- `POST /api/auth/register` - Регистрация
- `POST /api/auth/login` - Вход

### Auctions
- `GET /api/auctions` - Список аукционов
- `GET /api/auctions/:id` - Детали аукциона
- `POST /api/auctions` - Создать аукцион (требует auth)
- `POST /api/auctions/:id/start` - Запустить аукцион (требует auth)
- `POST /api/auctions/:id/bid` - Сделать ставку (требует auth)
- `GET /api/auctions/:id/leaderboard` - Таблица лидеров
- `GET /api/auctions/:id/bids` - Список ставок
- `GET /api/auctions/:id/min-bid` - Текущая минимальная ставка

### User
- `GET /api/user/me` - Информация о пользователе (требует auth)
- `POST /api/user/balance/add` - Пополнить баланс (требует auth)
- `GET /api/user/transactions` - История транзакций (требует auth)

### WebSocket
- `WS /ws/:auctionId` - Real-time обновления аукциона

## Структура проекта

```
auction-system/
├── src/
│   ├── config/
│   │   └── database.ts          # MongoDB и Redis подключения
│   ├── models/
│   │   ├── User.ts              # Модель пользователя
│   │   ├── Auction.ts           # Модель аукциона
│   │   ├── Bid.ts               # Модель ставки
│   │   └── Transaction.ts       # Модель транзакции
│   ├── services/
│   │   ├── authService.ts       # Аутентификация
│   │   ├── auctionService.ts    # Управление аукционами
│   │   ├── biddingService.ts    # Обработка ставок
│   │   ├── botService.ts        # Боты
│   │   ├── auctionLifecycleService.ts  # Жизненный цикл аукционов
│   │   └── websocketService.ts  # WebSocket
│   ├── routes/
│   │   ├── authRoutes.ts        # API авторизации
│   │   ├── auctionRoutes.ts     # API аукционов
│   │   └── userRoutes.ts        # API пользователя
│   ├── middleware/
│   │   └── auth.ts              # Middleware авторизации
│   └── index.ts                 # Точка входа
├── public/
│   ├── index.html               # Главная страница
│   ├── styles.css               # Стили
│   └── app.js                   # Frontend логика
├── Dockerfile
├── docker-compose.yml
├── package.json
├── tsconfig.json
└── README.md
```

## Логика работы

### Раунды

1. Аукцион создается со статусом `pending`
2. При старте статус меняется на `active`, начинается раунд 1
3. Участники делают ставки в течение времени раунда
4. По окончании раунда:
   - Определяются N победителей (самые высокие ставки)
   - Проигравшим возвращаются средства
   - Начинается следующий раунд
5. После всех раундов аукцион переходит в статус `completed`

### Приоритет ставок

При одинаковых суммах:
1. Сначала сравнивается сумма ставки (больше = лучше)
2. При равенстве сумм - по времени (раньше = лучше)

### Финансовая безопасность

- Средства списываются сразу при ставке
- Используются MongoDB транзакции
- Message Queue гарантирует порядок обработки
- Проверка баланса перед ставкой
- Автоматический возврат средств проигравшим

## Разработка

## Производительность

- Redis Message Queue для конкурентной обработки ставок
- WebSocket для минимальной задержки real-time обновлений
- MongoDB индексы для быстрых запросов
- Пагинация для списков (топ 10-50 элементов)

## Безопасность

- Пароли хешируются с bcrypt
- JWT токены для авторизации
- Проверка прав доступа
- Валидация всех входных данных
- Rate limiting на ставки (5 секунд между ставками)

## Автор
@Xonyae

Created for auction contest
